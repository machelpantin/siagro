---
title: "Climate data"
execute:
  echo: false
---

Climatic variables impact directly on agricultural production.

::: {.panel-tabset}

```{python}
#| warning: false
#| message: false
#| results: asis

import pandas as pd
import numpy as np
import requests
from pyecharts.charts import Scatter, Line
from pyecharts import options as opts
from IPython.display import HTML

# 1. 核心配置：禁用 pyecharts 的 requirejs 自动探测，强制使用全量加载
from pyecharts.globals import CurrentConfig
CurrentConfig.ONLINE_HOST = "[https://assets.pyecharts.org/assets/v5/](https://assets.pyecharts.org/assets/v5/)"

# 2. 获取数据
def fetch_data(indicator_id):
    url = f"[https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/](https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/){indicator_id}/data/en"
    try:
        r = requests.get(url, timeout=30)
        return pd.DataFrame(r.json()['body']['data'])
    except:
        return pd.DataFrame()

df = fetch_data(4470)

# 3. 绘图函数
def render_country_chart(df, pais):
    sub = df[df['dim_name_1'] == pais].copy()
    sub["value"] = pd.to_numeric(sub["value"], errors="coerce")
    sub["year"] = pd.to_numeric(sub["dim_name_3"], errors="coerce")
    sub = sub.dropna(subset=["year", "value"]).sort_values("year")

    if sub.empty: return

    # 计算距平
    mask = (sub["year"] >= 1960) & (sub["year"] <= 1990)
    baseline = sub.loc[mask, "value"].mean() or sub["value"].mean()
    sub["diff"] = sub["value"] - baseline

    # 绘图
    chart = Scatter(init_opts=opts.InitOpts(width="100%", height="500px"))
    chart.add_xaxis(sub["year"].tolist())
    chart.add_yaxis("Anomaly", sub["diff"].round(3).tolist(), symbol_size=8)
    
    chart.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temp Anomaly: {pais}"),
        xaxis_opts=opts.AxisOpts(type_="value", splitline_opts=opts.SplitLineOpts(is_show=False)),
        yaxis_opts=opts.AxisOpts(name="°C"),
        datazoom_opts=[opts.DataZoomOpts()]
    )
    
    # 关键点：使用 Quarto 语法生成选项卡标题
    print(f'## {pais}')
    # 输出图表的 HTML 源码
    print(chart.render_embed())

# 4. 执行循环渲染
if not df.empty:
    countries = sorted(df['dim_name_1'].unique())
    # 限制前几个国家测试，如果成功再扩展
    for c in countries:
        render_country_chart(df, c)
else:
    print("Error: No data")
