import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
from utils_siagro import cepal_data

# é¡µé¢é…ç½®
st.set_page_config(page_title="CEPAL æ¸©åº¦æ•°æ®å¯è§†åŒ–", layout="wide")

# å¸¸é‡
HISTORICAL_PERIOD_CODE = 85163  # 1960-1990 å†å²æ—¶æœŸ

st.title("ğŸŒ¡ï¸ æ‹‰ç¾åœ°åŒºå†å²æœˆå‡æ¸©åº¦åˆ†æ")
st.markdown("æ•°æ®æ¥æºï¼šCEPALSTAT (1960-1990)")

# è·å–æ•°æ®å¹¶ç¼“å­˜ä»¥æé«˜ç½‘é¡µåŠ è½½é€Ÿåº¦
@st.cache_data
def load_data():
    try:
        df = cepal_data([4470], lang='en')
        if df.empty:
            return None, "ä» CEPALSTAT è·å–çš„æ•°æ®ä¸ºç©ºã€‚"
        return df, None
    except Exception as e:
        return None, str(e)

df, error = load_data()

if error:
    st.error(f"æ— æ³•è·å–æ•°æ®: {error}")
elif df is not None:
    # 1. æ•°æ®é¢„å¤„ç†
    if 'dim_85162' in df.columns:
        df_filtered = df[df['dim_85162'] == HISTORICAL_PERIOD_CODE].copy()
        if df_filtered.empty:
            st.warning("1960-1990 æ—¶æœŸæ— æ•°æ®ï¼Œå·²åˆ‡æ¢ä¸ºå…¨éƒ¨æ•°æ®ã€‚")
            df_filtered = df.copy()
    else:
        df_filtered = df.copy()

    df_filtered['value'] = pd.to_numeric(df_filtered['value'], errors='coerce')
    
    # æ£€æŸ¥åˆ—å
    target_col = 'Subnational administrative division'
    if target_col not in df_filtered.columns or 'Months' not in df_filtered.columns:
        st.error("æ•°æ®ç¼ºå°‘å¿…è¦åˆ—ï¼ˆå›½å®¶æˆ–æœˆä»½ï¼‰ã€‚")
    else:
        # æœˆä»½æ’åºé€»è¾‘
        month_order = ['January', 'February', 'March', 'April', 'May', 'June',
                       'July', 'August', 'September', 'October', 'November', 'December']
        
        # ä¾§è¾¹æ ï¼šäº¤äº’æ§ä»¶
        st.sidebar.header("ç­›é€‰å™¨")
        all_countries = sorted(df_filtered[target_col].dropna().unique())
        selected_countries = st.sidebar.multiselect(
            "é€‰æ‹©è¦å¯¹æ¯”çš„å›½å®¶/åœ°åŒº",
            options=all_countries,
            default=all_countries[:3] if len(all_countries) > 3 else all_countries
        )

        # è¿‡æ»¤ç”¨æˆ·é€‰æ‹©çš„æ•°æ®
        df_plot = df_filtered[df_filtered[target_col].isin(selected_countries)].copy()

        if not df_plot.empty:
            # å‡†å¤‡ç»˜å›¾æ•°æ®
            df_monthly = df_plot.groupby([target_col, 'Months'])['value'].mean().round(2).reset_index()
            df_monthly['Months'] = pd.Categorical(df_monthly['Months'], categories=month_order, ordered=True)
            df_monthly = df_monthly.sort_values('Months')

            # --- å›¾è¡¨å±•ç¤º ---
            col1, col2 = st.columns(2)

            with col1:
                st.subheader("ğŸ“Š æœˆå‡æ¸©åº¦æŸ±çŠ¶å›¾")
                fig1 = px.bar(df_monthly, x='Months', y='value', color=target_col,
                             title="Monthly Average Temp (1960-1990)",
                             barmode='group', height=500)
                st.plotly_chart(fig1, use_container_width=True)

            with col2:
                st.subheader("ğŸ“ˆ æ¸©åº¦å˜åŒ–è¶‹åŠ¿")
                fig2 = px.line(df_monthly, x='Months', y='value', color=target_col,
                              title="Temperature Comparison Trend",
                              markers=True, height=500)
                st.plotly_chart(fig2, use_container_width=True)

            st.divider()

            # æ’åå›¾è¡¨
            st.subheader("ğŸ† å›½å®¶å¹´å‡æ¸©åº¦æ’å")
            df_rank = df_plot.groupby(target_col)['value'].mean().round(2).reset_index()
            df_rank = df_rank.sort_values('value', ascending=True)
            
            fig3 = px.bar(df_rank, x='value', y=target_col, orientation='h',
                         color='value', color_continuous_scale='Oranges',
                         labels={'value': 'Temperature (Â°C)', target_col: ''},
                         height=400)
            st.plotly_chart(fig3, use_container_width=True)
        else:
            st.info("è¯·åœ¨ä¾§è¾¹æ é€‰æ‹©è‡³å°‘ä¸€ä¸ªå›½å®¶è¿›è¡ŒæŸ¥çœ‹ã€‚")
