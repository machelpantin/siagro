```{python}
#| echo: false
#| warning: false

import pandas as pd
import numpy as np
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from pyecharts.commons.utils import JsCode
from utils_siagro import cepal_data
from IPython.display import HTML

# 1. 获取数据 (确保使用的是你想展示的指标 ID，比如 4470)
df = cepal_data([4470], lang='en')

def build_chart(df, pais):
    # 筛选该国家数据
    atmp = df[df['Subnational administrative division'] == pais].copy()
    
    # 转换数值
    atmp["value"] = pd.to_numeric(atmp["value"], errors="coerce")
    # 自动匹配年份列
    year_col = 'Years' if 'Years' in atmp.columns else 'Años__ESTANDAR'
    atmp["year"] = pd.to_numeric(atmp[year_col], errors="coerce")
    
    atmp = atmp.dropna(subset=["year", "value"]).sort_values("year")

    if atmp.empty:
        return None

    # 基准线 1960–1990
    mask = (atmp["year"] >= 1960) & (atmp["year"] <= 1990)
    baseline = atmp.loc[mask, "value"].mean()
    if np.isnan(baseline):
        baseline = atmp["value"].mean()
        
    atmp["temp-diff"] = atmp["value"] - baseline

    # 年代统计
    atmp["decade_start"] = (atmp["year"] // 10) * 10
    decade_stats = atmp.groupby("decade_start").agg(
        year_min=("year","min"),
        year_max=("year","max"),
        avg_10yr=("value","mean")
    ).reset_index()

    # 绘图
    chart = Scatter(init_opts=opts.InitOpts(width="800px", height="550px"))
    chart.add_xaxis(atmp["year"].tolist())
    chart.add_yaxis(
        "Annual Anomaly",
        atmp["temp-diff"].round(3).tolist(),
        symbol_size=8,
        itemstyle_opts=opts.ItemStyleOpts(color="#1f77b4", opacity=0.8),
        label_opts=opts.LabelOpts(is_show=False),
    )

    for r in decade_stats.itertuples():
        y_anom = r.avg_10yr - baseline
        line = Line().add_xaxis([int(r.year_min), int(r.year_max)])
        line.add_yaxis("Decade Avg", [round(y_anom, 3), round(y_anom, 3)],
                       symbol="none", linestyle_opts=opts.LineStyleOpts(color="#ff7f0e", width=3),
                       label_opts=opts.LabelOpts(is_show=False))
        chart.overlap(line)

    chart.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temp Anomaly - {pais}"),
        xaxis_opts=opts.AxisOpts(type_="value", name="Year", splitline_opts=opts.SplitLineOpts(is_show=False)),
        yaxis_opts=opts.AxisOpts(name="Temp Diff (°C)"),
        tooltip_opts=opts.TooltipOpts(trigger="item", formatter="{b}: {c}°C"),
        datazoom_opts=[opts.DataZoomOpts()]
    )
    return chart

# 生成 Tab 并渲染
if not df.empty:
    country_col = 'Subnational administrative division'
    pais_values = sorted(df[country_col].unique())
    tab = Tab()

    for pais in pais_values:
        c = build_chart(df, pais)
        if c:
            tab.add(c, pais)
    
    # 关键修改：渲染为 HTML 字符串供 Quarto 捕获
    display(HTML(tab.render_embed()))
else:
    print("No data available")
