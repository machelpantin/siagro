---
title: "Climate data"
execute:
  echo: false
---
Climatic variables impact directly on agricultural production. This section includes annual and monthly data on temperature and precipitation at a national level.

Las variables climáticas inciden directamente en la producción agrícola. Esta sección incluye datos anuales y mensuales de temperatura y precipitación a nivel nacional.

```{python}
import pandas as pd
import numpy as np
import pyecharts
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from pyecharts.commons.utils import JsCode
from utils_siagro import cepal_data
import logging

logging.getLogger().setLevel(logging.WARNING)

# 1. 获取数据 (保持与原项目 utils_siagro 兼容)
# 使用 4470 指标 (Annual Average Temperature)
df = cepal_data([4470], lang='en')

# -------------------------------------------------
# Function: Build ONE chart for one country
# -------------------------------------------------
def build_chart(df, pais):
    # 适配指标 4470 的列名
    # 根据你之前代码的列名：Subnational administrative division 和 value
    atmp = df[df['Subnational administrative division'] == pais].copy()
    
    atmp["value"] = pd.to_numeric(atmp["value"], errors="coerce")
    # 这里的年份列名如果是 4470 指标，通常是 'Years' 或 'dim_name_3'
    # 我们尝试自动识别年份列
    year_col = 'Years' if 'Years' in atmp.columns else 'Años__ESTANDAR'
    atmp["year"] = pd.to_numeric(atmp[year_col], errors="coerce")
    
    atmp = atmp.dropna(subset=["year", "value"]).sort_values("year")

    if atmp.empty:
        return None

    # baseline 1960–1990
    mask = (atmp["year"] >= 1960) & (atmp["year"] <= 1990)
    baseline = atmp.loc[mask, "value"].mean()
    if np.isnan(baseline):
        baseline = atmp["value"].mean()
        
    atmp["temp-diff"] = atmp["value"] - baseline

    # decade stats
    atmp["decade_start"] = (atmp["year"] // 10) * 10
    decade_stats = (
        atmp.groupby("decade_start")
            .agg(year_min=("year","min"),
                 year_max=("year","max"),
                 avg_10yr=("value","mean"))
            .reset_index()
    )

    # --- 绘图配置 ---
    chart = Scatter(init_opts=opts.InitOpts(width="800px", height="500px"))
    chart.add_xaxis(atmp["year"].tolist())
    chart.add_yaxis(
        "Annual Anomaly",
        atmp["temp-diff"].round(3).tolist(),
        symbol_size=8,
        itemstyle_opts=opts.ItemStyleOpts(color="#1f77b4", opacity=0.8),
        label_opts=opts.LabelOpts(is_show=False),
    )

    # 叠加年代线
    for r in decade_stats.itertuples():
        y_anom = r.avg_10yr - baseline
        line = Line()
        line.add_xaxis([int(r.year_min), int(r.year_max)])
        line.add_yaxis(
            "Decade Avg",
            [round(y_anom, 3), round(y_anom, 3)],
            symbol="none",
            linestyle_opts=opts.LineStyleOpts(color="#ff7f0e", width=3),
            label_opts=opts.LabelOpts(is_show=False),
        )
        chart.overlap(line)

    int_formatter = JsCode("function (v) { return Math.round(v).toString(); }")

    chart.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temp Anomaly (Baseline 1960-1990) - {pais}"),
        xaxis_opts=opts.AxisOpts(
            name="Year", type_="value",
            axislabel_opts=opts.LabelOpts(formatter=int_formatter),
            splitline_opts=opts.SplitLineOpts(is_show=False)
        ),
        yaxis_opts=opts.AxisOpts(name="Temp Diff (°C)"),
        tooltip_opts=opts.TooltipOpts(trigger="item", formatter="{b}: {c}°C"),
        datazoom_opts=[opts.DataZoomOpts(type_="slider")] # 方便在网页上缩放查看
    )

    return chart

# -------------------------------------------------
# Build Tabs with all countries
# -------------------------------------------------
if not df.empty:
    country_col = 'Subnational administrative division'
    pais_values = sorted(df[country_col].unique())
    tab = Tab()

    for pais in pais_values:
        c = build_chart(df, pais)
        if c:
            tab.add(c, pais)
    
    # 在 Quarto 环境中，这里要用 render_notebook()
    tab.render_notebook()
else:
    print("No data found for the specified indicator.")
