import pandas as pd
import numpy as np
import requests
import logging
from pyecharts.charts import Bar, Tab, Line
from pyecharts import options as opts
from pyecharts.commons.utils import JsCode
from pyecharts.globals import CurrentConfig

# è®¾ç½® Pyecharts èµ„æºåœ°å€ï¼Œç¡®ä¿å›¾è¡¨èƒ½æ­£å¸¸æ˜¾ç¤º
CurrentConfig.ONLINE_HOST = "https://assets.pyecharts.org/assets/v5/"


# æ¨¡æ‹Ÿ utils_siagro çš„æ•°æ®è·å–åŠŸèƒ½
def fetch_cepal_data(indicator_id):
    print(f"æ­£åœ¨ä» API è·å–æŒ‡æ ‡ {indicator_id} çš„æ•°æ®...")
    url = f"https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/{indicator_id}/data/en"
    try:
        r = requests.get(url, timeout=30)
        r.raise_for_status()
        # è¿™é‡Œçš„ JSON è§£æè·¯å¾„å‚è€ƒäº† CEPALSTAT çš„å¸¸è§ç»“æ„
        data = r.json()['body']['data']
        return pd.DataFrame(data)
    except Exception as e:
        print(f"æ•°æ®æŠ“å–å¤±è´¥: {e}")
        return pd.DataFrame()


# --- 1. è·å–å¹¶æ¸…æ´—æ•°æ® ---
df = fetch_cepal_data(4470)

# æœˆä»½æ ‡å‡†æ’åº
month_order = {
    'January': 1, 'February': 2, 'March': 3, 'April': 4,
    'May': 5, 'June': 6, 'July': 7, 'August': 8,
    'September': 9, 'October': 10, 'November': 11, 'December': 12
}

# ç­›é€‰ 1960-1990 å†å²æ•°æ®
if not df.empty:
    if 'dim_85162' in df.columns:
        df_filtered = df[df['dim_85162'] == 85163].copy()
    else:
        df_filtered = df.copy()

    df_filtered['value'] = pd.to_numeric(df_filtered['value'], errors='coerce')

    # --- 2. æ„å»ºå›¾è¡¨ ---
    country_names = ['Belize', 'Costa Rica', 'Cuba', 'El Salvador', 'Guatemala',
                     'Haiti', 'Honduras', 'Mexico', 'Panama', 'Dominican Republic']

    # åˆ›å»ºé€‰é¡¹å¡å®¹å™¨
    tab = Tab()

    for country in country_names:
        # dim_name_1 é€šå¸¸æ˜¯ API ä¸­çš„å›½å®¶ååˆ—
        country_data = df_filtered[df_filtered['dim_name_1'] == country].copy()
        if country_data.empty: continue

        # è®¡ç®—æœˆå¹³å‡å€¼
        # dim_name_2 é€šå¸¸æ˜¯ API ä¸­çš„æœˆä»½ååˆ—
        monthly_avg = country_data.groupby('dim_name_2')['value'].mean().reset_index()
        monthly_avg['num'] = monthly_avg['dim_name_2'].map(month_order)
        monthly_avg = monthly_avg.sort_values('num')

        bar = Bar(init_opts=opts.InitOpts(width="900px", height="500px"))
        bar.add_xaxis(monthly_avg['dim_name_2'].tolist())
        bar.add_yaxis(
            "Temperature (Â°C)",
            monthly_avg['value'].round(2).tolist(),
            label_opts=opts.LabelOpts(is_show=True, position="top", formatter="{c}Â°C")
        )
        bar.set_global_opts(title_opts=opts.TitleOpts(title=f"Monthly Temp - {country}"))
        tab.add(bar, country)

    # --- 3. ç”Ÿæˆå¹¶å±•ç¤ºç»“æœ ---
    output_filename = "climate_change_report.html"
    tab.render(output_filename)
    print(f"\nâœ… è¿è¡ŒæˆåŠŸï¼")
    print(f"ğŸ‘‰ è¯·åœ¨ä½ çš„é¡¹ç›®ç›®å½•ä¸‹æ‰¾åˆ° '{output_filename}'ï¼ŒåŒå‡»ç”¨æµè§ˆå™¨æ‰“å¼€å³å¯ã€‚")

else:
    print("âŒ æœªæŠ“å–åˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚")