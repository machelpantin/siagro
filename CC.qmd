---
title: "Climate Data Analysis"
execute:
  echo: false
---

Climatic variables impact directly on agricultural production. This section provides a comparative analysis of monthly and annual average temperatures (1960-1990).



## ğŸ“Š Monthly Details by Country

```{python}
#| warning: false
#| message: false
#| results: asis

import pandas as pd
import numpy as np
import requests
from pyecharts.charts import Bar
from pyecharts import options as opts
from IPython.display import HTML, display, Markdown

# 1. æ ¸å¿ƒé…ç½®ï¼šè§£å†³ GitHub Pages HTTPS ç¯å¢ƒä¸‹çš„åŠ è½½é—®é¢˜
from pyecharts.globals import CurrentConfig
CurrentConfig.ONLINE_HOST = "https://assets.pyecharts.org/assets/v5/"

# 2. æ•°æ®è·å–
from utils_siagro import cepal_data  # imports from own module
import logging
df = cepal_data([4470], lang='en')

# --- fix: ensure value is numeric and import Markdown for headings ---
df['value'] = pd.to_numeric(df.get('value', pd.Series(dtype='float')), errors='coerce')

# æœˆä»½æ’åºé¡ºåº
month_order = ['January', 'February', 'March', 'April', 'May', 'June',
               'July', 'August', 'September', 'October', 'November', 'December']

# Validate required columns before proceeding
required_cols = ['Months', 'value', 'dim_85162', 'Subnational administrative division']
missing_cols = [c for c in required_cols if c not in df.columns]

if df.empty:
    print("Error: Could not retrieve data from API.")
elif missing_cols:
    print(f"Error: Missing expected columns in the data: {missing_cols}")
else:
    # ç­›é€‰ 1960-1990 æ—¶æœŸ (å¯¹åº”ä»£ç  85163)
    target_period = "85163"
    df_filtered = df[df['dim_85162'] == target_period].copy()
    if df_filtered.empty:
        df_filtered = df.copy()

    # è·å–åœ°åŒºåˆ—è¡¨å¹¶å¾ªç¯æ¸²æŸ“
    target_col = 'Subnational administrative division'
    locations = sorted(df_filtered[target_col].dropna().unique())

    for loc in locations:
        try:
            sub = df_filtered[df_filtered[target_col] == loc].copy()
            # Ensure Months column is string and categorical with the correct order
            sub['Months'] = sub['Months'].astype(str)
            sub['Months'] = pd.Categorical(sub['Months'], categories=month_order, ordered=True)

            # èšåˆæ¯ä¸ªæœˆçš„æ•°æ®ï¼Œç¡®ä¿æŒ‰ month_order æ’åºå¹¶ä¸”ä¿ç•™ç¼ºå¤±æœˆä»½
            monthly_avg = sub.groupby('Months', sort=False, observed=False)['value'].mean()
            monthly_avg = monthly_avg.reindex(month_order).reset_index()
            monthly_avg.columns = ['Months', 'value']

            # Replace NaN with None so JS charts can handle missing points
            monthly_values = [None if pd.isna(v) else round(float(v), 2) for v in monthly_avg['value'].tolist()]

            # ç»˜åˆ¶æŸ±çŠ¶å›¾
            bar = Bar(init_opts=opts.InitOpts(width="100%", height="450px"))
            bar.add_xaxis(month_order)
            bar.add_yaxis("Avg Temperature", monthly_values)
            bar.set_global_opts(
                title_opts=opts.TitleOpts(title=f"Monthly Average Temp - {loc}"),
                yaxis_opts=opts.AxisOpts(name="Temperature (Â°C)"),
                tooltip_opts=opts.TooltipOpts(trigger="axis")
            )

            # ä½¿ç”¨ Quarto è¯­æ³•ç”Ÿæˆå­é€‰é¡¹å¡æ ‡é¢˜å¹¶åµŒå…¥å›¾è¡¨
            display(Markdown(f"### {loc}"))
            # render standalone HTML and embed via iframe (reliable for Quarto sites)
            import re
            from pathlib import Path
            charts_dir = Path("charts")
            charts_dir.mkdir(exist_ok=True)
            safe_name = re.sub(r'[^A-Za-z0-9_-]+', '_', loc).strip('_').lower()
            html_path = charts_dir / f"{safe_name}.html"
            bar.render(str(html_path))
            iframe_html = f'<iframe src="{html_path.as_posix()}" width="100%" height="480" frameborder="0"></iframe>'
            display(HTML(iframe_html))
        except Exception as e:
            print(f"Plotting error for {loc}: {e}")
````
