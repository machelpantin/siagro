```{python}
#| echo: false
#| warning: false
#| message: false

import pandas as pd
import numpy as np
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from utils_siagro import cepal_data
from IPython.display import HTML, display

# 1. 强制使用全局引用模式，避开 require.js 的干扰
from pyecharts.globals import CurrentConfig
CurrentConfig.ONLINE_HOST = "[https://assets.pyecharts.org/assets/v5/](https://assets.pyecharts.org/assets/v5/)"

# 2. 获取数据
df = cepal_data([4470], lang='en')

def build_chart(df, pais):
    atmp = df[df['Subnational administrative division'] == pais].copy()
    atmp["value"] = pd.to_numeric(atmp["value"], errors="coerce")
    year_col = 'Years' if 'Years' in atmp.columns else 'Años__ESTANDAR'
    atmp["year"] = pd.to_numeric(atmp[year_col], errors="coerce")
    atmp = atmp.dropna(subset=["year", "value"]).sort_values("year")

    if atmp.empty: return None

    # 计算距平
    mask = (atmp["year"] >= 1960) & (atmp["year"] <= 1990)
    baseline = atmp.loc[mask, "value"].mean()
    if np.isnan(baseline): baseline = atmp["value"].mean()
    atmp["diff"] = atmp["value"] - baseline

    # 绘图
    chart = Scatter(init_opts=opts.InitOpts(width="100%", height="500px"))
    chart.add_xaxis(atmp["year"].tolist())
    chart.add_yaxis("Anomaly", atmp["diff"].round(3).tolist(), symbol_size=8)
    
    chart.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temp Anomaly: {pais}"),
        xaxis_opts=opts.AxisOpts(type_="value", splitline_opts=opts.SplitLineOpts(is_show=False)),
        datazoom_opts=[opts.DataZoomOpts()]
    )
    return chart

# 3. 核心修复点：使用 render_embed() 配合 display(HTML(...))
if not df.empty:
    countries = sorted(df['Subnational administrative division'].unique())
    tab = Tab()
    for c in countries:
        fig = build_chart(df, c)
        if fig: tab.add(fig, c)
    
    # render_embed() 会生成不依赖外部 require.js 的独立代码块
    output_html = tab.render_embed()
    display(HTML(output_html))
else:
    print("No Data")
