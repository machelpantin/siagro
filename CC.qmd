---
import pandas as pd
import numpy as np
from utils_siagro import cepal_data
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots

# 常量
HISTORICAL_PERIOD_CODE = 85163  # 1960-1990 历史时期

# 获取数据
try:
    df = cepal_data([4470], lang='en')
    if df.empty:
        raise ValueError("从 CEPALSTAT 获取的数据为空。")
except Exception as e:
    print(f"**错误：无法获取数据** - {e}")
    df = pd.DataFrame()

if df.empty:
    print("**无数据可用，后续图表无法生成。**")
else:
    # 必要列检查
    required_cols = ['value']
    if not all(col in df.columns for col in required_cols):
        print("**错误：数据缺少必要列，无法生成图表。**")
    else:
        # 过滤历史时期
        if 'dim_85162' in df.columns:
            df_filtered = df[df['dim_85162'] == HISTORICAL_PERIOD_CODE].copy()
            if df_filtered.empty:
                print("**警告：1960-1990 时期无数据，使用全部数据替代。**")
                df_filtered = df.copy()
        else:
            df_filtered = df.copy()

        df_filtered['value'] = pd.to_numeric(df_filtered['value'], errors='coerce')

        # 检查关键列
        if not {'Subnational administrative division', 'Months'}.issubset(df_filtered.columns):
            print("**错误：缺少国家或月份列，无法生成图表。**")
        else:
            # 动态获取国家列表并排序
            country_names = sorted(df_filtered['Subnational administrative division'].dropna().unique())
            print(f"**检测到 {len(country_names)} 个国家/地区：** {', '.join(country_names)}")

            # 月份顺序
            month_order = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December']

            # 1. 单个国家月均温度柱状图（Tab 效果用下拉菜单替代，更适合网页）
            print("### 国家月均温度比较（请选择国家）")
            country_data_long = []
            for country in country_names:
                sub = df_filtered[df_filtered['Subnational administrative division'] == country].copy()
                if not sub.empty:
                    monthly_avg = sub.groupby('Months')['value'].mean().round(2).reset_index()
                    monthly_avg['Country'] = country
                    country_data_long.append(monthly_avg)

            if country_data_long:
                df_monthly = pd.concat(country_data_long)
                df_monthly['Months'] = pd.Categorical(df_monthly['Months'], categories=month_order, ordered=True)
                df_monthly = df_monthly.sort_values('Months')

                fig1 = px.bar(df_monthly,
                              x='Months', y='value', color='Country',
                              title="Monthly Average Temperature by Country (1960-1990)",
                              labels={'value': 'Temperature (°C)', 'Months': 'Month'},
                              category_orders={'Months': month_order},
                              barmode='group',
                              height=600)
                fig1.update_layout(legend_title="Country",
                                   xaxis_title="Month",
                                   yaxis_title="Temperature (°C)",
                                   hovermode="x unified")
                fig1.show()

            # 2. 多国家温度对比折线图
            print("### 多国家月均温度折线对比")
            if country_data_long:
                fig2 = px.line(df_monthly,
                               x='Months', y='value', color='Country',
                               title="Monthly Temperature Comparison (1960-1990)",
                               labels={'value': 'Temperature (°C)', 'Months': 'Month'},
                               category_orders={'Months': month_order},
                               markers=True,
                               height=600)
                fig2.update_layout(legend_title="Country",
                                   xaxis_title="Month",
                                   yaxis_title="Temperature (°C)",
                                   hovermode="x unified")
                fig2.show()

            # 3. 国家年均温度排名横向柱状图
            print("### 国家年均温度排名（1960-1990）")
            country_avg = []
            for country in country_names:
                sub = df_filtered[df_filtered['Subnational administrative division'] == country]
                if not sub.empty:
                    mean_temp = sub['value'].mean()
                    if not np.isnan(mean_temp):
                        country_avg.append({'Country': country, 'Temperature': round(mean_temp, 2)})

            if country_avg:
                df_rank = pd.DataFrame(country_avg).sort_values('Temperature', ascending=True)
                
                fig3 = px.bar(df_rank,
                              x='Temperature', y='Country',
                              orientation='h',
                              title="Average Annual Temperature by Country (1960-1990)",
                              labels={'Temperature': 'Temperature (°C)'},
                              height=500,
                              color='Temperature',
                              color_continuous_scale='Oranges')
                fig3.update_layout(yaxis_title="",
                                   xaxis_title="Temperature (°C)",
                                   showlegend=False)
                fig3.show()
