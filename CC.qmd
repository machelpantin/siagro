---
title: "Climate data"
execute:
  echo: false
---

Climatic variables impact directly on agricultural production. This section includes annual and monthly data on temperature and precipitation at a national level.

Las variables climáticas inciden directamente en la producción agrícola. Esta sección incluye datos anuales y mensuales de temperatura y precipitación a nivel nacional.

```{python}
#| warning: false
#| message: false

import pandas as pd
import numpy as np
import requests
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from IPython.display import HTML, display

# 1. 强制使用 HTTPS CDN，解决 GitHub Pages 不加载图表的问题
from pyecharts.globals import CurrentConfig
CurrentConfig.ONLINE_HOST = "[https://assets.pyecharts.org/assets/v5/](https://assets.pyecharts.org/assets/v5/)"

# 2. 数据获取函数 (由于没有 utils_siagro，直接请求 CEPALSTAT 接口)
def fetch_data(indicator_id):
    url = f"[https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/](https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/){indicator_id}/data/en"
    try:
        r = requests.get(url, timeout=30)
        r.raise_for_status()
        # 提取数据主体
        return pd.DataFrame(r.json()['body']['data'])
    except:
        return pd.DataFrame()

# 获取平均气温指标数据
df = fetch_data(4470)

# 3. 绘图函数
def build_chart(df, pais):
    # 根据 API 结构筛选：dim_name_1 是国家，dim_name_3 是年份
    atmp = df[df['dim_name_1'] == pais].copy()
    
    atmp["value"] = pd.to_numeric(atmp["value"], errors="coerce")
    atmp["year"] = pd.to_numeric(atmp["dim_name_3"], errors="coerce")
    atmp = atmp.dropna(subset=["year", "value"]).sort_values("year")

    if atmp.empty:
        return None

    # 计算 1960-1990 基准距平 (Anomaly)
    mask = (atmp["year"] >= 1960) & (atmp["year"] <= 1990)
    baseline = atmp.loc[mask, "value"].mean()
    if np.isnan(baseline):
        baseline = atmp["value"].mean()
        
    atmp["diff"] = atmp["value"] - baseline

    # 计算年代平均值趋势
    atmp["decade"] = (atmp["year"] // 10) * 10
    decade_stats = atmp.groupby("decade")["value"].mean() - baseline

    # 散点图绘制
    scatter = Scatter(init_opts=opts.InitOpts(width="800px", height="500px"))
    scatter.add_xaxis(atmp["year"].tolist())
    scatter.add_yaxis(
        "Annual Anomaly",
        atmp["diff"].round(3).tolist(),
        symbol_size=8,
        itemstyle_opts=opts.ItemStyleOpts(color="#1f77b4", opacity=0.8),
        label_opts=opts.LabelOpts(is_show=False),
    )

    # 叠加年代线
    for dec, val in decade_stats.items():
        line = Line().add_xaxis([int(dec), int(dec + 9)])
        line.add_yaxis(
            "Decadal Avg",
            [round(val, 3), round(val, 3)],
            symbol="none",
            linestyle_opts=opts.LineStyleOpts(color="#ff7f0e", width=3),
            label_opts=opts.LabelOpts(is_show=False)
        )
        scatter.overlap(line)

    scatter.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temp Anomaly: {pais}"),
        xaxis_opts=opts.AxisOpts(type_="value", splitline_opts=opts.SplitLineOpts(is_show=False)),
        yaxis_opts=opts.AxisOpts(name="°C diff"),
        tooltip_opts=opts.TooltipOpts(trigger="item"),
        datazoom_opts=[opts.DataZoomOpts()]
    )
    return scatter

# 4. 生成选项卡并渲染
if not df.empty:
    countries = sorted(df['dim_name_1'].unique())
    tab = Tab()
    for c in countries:
        fig = build_chart(df, c)
        if fig:
            tab.add(fig, c)
    
    # 【核心修复点】render_embed() 生成不依赖 RequireJS 的独立代码块
    display(HTML(tab.render_embed()))
else:
    display(HTML("<b style='color:red;'>Error: Could not fetch data from CEPAL API.</b>"))
