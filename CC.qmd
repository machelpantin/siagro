---
title: "Climate Data Analysis"
execute:
  echo: false
---

Climatic variables impact directly on agricultural production. This section provides a comparative analysis of monthly and annual average temperatures (1960-1990).

::: {.panel-tabset}

## ğŸ“Š Monthly Details by Country

```{python}
#| warning: false
#| message: false
#| results: asis

import pandas as pd
import numpy as np
import requests
from pyecharts.charts import Bar
from pyecharts import options as opts
from IPython.display import HTML, display

# 1. æ ¸å¿ƒé…ç½®ï¼šè§£å†³ GitHub Pages HTTPS ç¯å¢ƒä¸‹çš„åŠ è½½é—®é¢˜
from pyecharts.globals import CurrentConfig
CurrentConfig.ONLINE_HOST = "[https://assets.pyecharts.org/assets/v5/](https://assets.pyecharts.org/assets/v5/)"

# 2. æ•°æ®è·å–
def get_data():
    url = "[https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/4470/data/en](https://api-cepalstat.cepal.org/cepalstat/api/v1/indicator/4470/data/en)"
    try:
        r = requests.get(url, timeout=30)
        df = pd.DataFrame(r.json()['body']['data'])
        df['value'] = pd.to_numeric(df['value'], errors='coerce')
        return df
    except:
        return pd.DataFrame()

df = get_data()

# æœˆä»½æ’åºé¡ºåº
month_order = ['January', 'February', 'March', 'April', 'May', 'June',
               'July', 'August', 'September', 'October', 'November', 'December']

if not df.empty:
    # ç­›é€‰ 1960-1990 æ—¶æœŸ (å¯¹åº”ä»£ç  85163)
    target_period = "85163"
    df_filtered = df[df['dim_85162'] == target_period].copy()
    if df_filtered.empty:
        df_filtered = df.copy()

    # è·å–åœ°åŒºåˆ—è¡¨å¹¶å¾ªç¯æ¸²æŸ“
    target_col = 'Subnational administrative division'
    locations = sorted(df_filtered[target_col].unique())

    for loc in locations:
        sub = df_filtered[df_filtered[target_col] == loc].copy()
        # èšåˆæ¯ä¸ªæœˆçš„æ•°æ®
        monthly_avg = sub.groupby('Months')['value'].mean().reindex(month_order).reset_index()
        
        # ç»˜åˆ¶æŸ±çŠ¶å›¾
        bar = Bar(init_opts=opts.InitOpts(width="100%", height="450px"))
        bar.add_xaxis(month_order)
        bar.add_yaxis("Avg Temperature", monthly_avg['value'].round(2).tolist(), color="#1f77b4")
        bar.set_global_opts(
            title_opts=opts.TitleOpts(title=f"Monthly Average Temp - {loc}"),
            yaxis_opts=opts.AxisOpts(name="Temperature (Â°C)"),
            tooltip_opts=opts.TooltipOpts(trigger="axis")
        )
        
        # --- å…³é”®ï¼šä½¿ç”¨ Quarto è¯­æ³•ç”Ÿæˆå­é€‰é¡¹å¡æ ‡é¢˜ ---
        print(f'### {loc}')
        # è¾“å‡ºå›¾è¡¨åµŒå…¥ä»£ç 
        print(bar.render_embed())
else:
    print("Error: Could not retrieve data from API.")
