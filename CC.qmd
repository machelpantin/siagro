import pandas as pd
import numpy as np
from utils_siagro import cepal_data
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from pyecharts.commons.utils import JsCode

# --- 1. 数据获取 ---
def get_processed_data():
    try:
        # 使用你原本的指标 ID: 4470 (或根据需求改为 3472)
        df = cepal_data([4470], lang='en')
        if df.empty:
            return None
        
        # 转换数值
        df['value'] = pd.to_numeric(df['value'], errors='coerce')
        # 这里的 Años__ESTANDAR 或 Years 根据你实际 API 返回的列名调整
        # 假设列名为 'Years'
        year_col = 'Years' if 'Years' in df.columns else 'Años__ESTANDAR'
        df['year'] = pd.to_numeric(df[year_col], errors='coerce')
        
        return df.dropna(subset=['value', 'year'])
    except Exception as e:
        print(f"Error fetching data: {e}")
        return None

# --- 2. 构建单个国家图表的函数 ---
def build_country_chart(df, country_name):
    # 过滤特定国家数据
    # 注意：列名请确保与 API 返回一致，这里使用你之前的 'Subnational administrative division'
    country_col = 'Subnational administrative division'
    sub = df[df[country_col] == country_name].copy().sort_values("year")

    # 计算 1960-1990 基准线 (Baseline)
    mask = (sub["year"] >= 1960) & (sub["year"] <= 1990)
    baseline = sub.loc[mask, "value"].mean()
    
    # 如果基准线为空（该国家在此时段无数据），则用全局平均
    if np.isnan(baseline):
        baseline = sub["value"].mean()
    
    sub["temp_diff"] = sub["value"] - baseline

    # 计算年代平均值 (Decade Stats)
    sub["decade"] = (sub["year"] // 10) * 10
    decade_stats = sub.groupby("decade").agg(
        year_min=("year", "min"),
        year_max=("year", "max"),
        avg_val=("value", "mean")
    ).reset_index()

    # --- 绘图 ---
    # 1. 散点图：年度异常值
    scatter = Scatter(init_opts=opts.InitOpts(width="800px", height="500px"))
    scatter.add_xaxis(sub["year"].tolist())
    scatter.add_yaxis(
        "Annual Anomaly",
        sub["temp_diff"].round(3).tolist(),
        symbol_size=8,
        itemstyle_opts=opts.ItemStyleOpts(color="#1f77b4", opacity=0.8),
        label_opts=opts.LabelOpts(is_show=False),
    )

    # 2. 折线图：年代平均值（层叠在散点图上）
    for r in decade_stats.itertuples():
        line = Line()
        y_anomaly = r.avg_val - baseline
        line.add_xaxis([int(r.year_min), int(r.year_max)])
        line.add_yaxis(
            "Decadal Average",
            [round(y_anomaly, 3), round(y_anomaly, 3)],
            symbol="none",
            is_connect_nones=True,
            linestyle_opts=opts.LineStyleOpts(color="#ff7f0e", width=3),
            label_opts=opts.LabelOpts(is_show=False),
        )
        scatter.overlap(line)

    # 全局配置
    scatter.set_global_opts(
        title_opts=opts.TitleOpts(title=
