---
title: "Climate data"
execute:
  echo: false
---
Climatic variables impact directly on agricultural production. This section includes annual and monthly data on temperature and precipitation at a national level.

Las variables climáticas inciden directamente en la producción agrícola. Esta sección incluye datos anuales y mensuales de temperatura y precipitación a nivel nacional.

```{python}
import requests
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np

import pyecharts

from utils_siagro import cepal_data #imports from own module
import logging
# Set logging level to WARNING to reduce output noise
logging.getLogger().setLevel(logging.WARNING)
```
```{python}
df = cepal_data([3472, 3475], lang='es')
```



```{python}
from pyecharts.charts import Scatter, Line, Tab
from pyecharts import options as opts
from pyecharts.commons.utils import JsCode

# -------------------------------------------------
# Function: Build ONE chart for one country
# -------------------------------------------------
def build_chart(df, pais):
    atmp = df[(df['indicator_id']==3472) &
              (df['País__ESTANDAR']== pais) &
              (df['dim_68102']==68104)].copy()
    atmp["value"] = pd.to_numeric(atmp["value"], errors="coerce")
    atmp["year"] = pd.to_numeric(atmp["Años__ESTANDAR"], errors="coerce")
    atmp = atmp.dropna(subset=["year"]).sort_values("year")

    # baseline 1960–1990
    mask = (atmp["year"]>=1960) & (atmp["year"]<=1990)
    baseline = atmp.loc[mask, "value"].mean()
    atmp["temp-diff"] = atmp["value"] - baseline

    # decade stats
    atmp["decade_start"] = ((atmp["year"]-1901)//10)*10 + 1901
    decade_stats = (
        atmp.groupby("decade_start")
            .agg(year_min=("year","min"),
                 year_max=("year","max"),
                 avg_10yr=("value","mean"))
            .reset_index()
    )

    # --- Colors ---
    matplotlib_c0 = "#1f77b4"
    matplotlib_c1 = "#ff7f0e"

    # --- Base scatter ---
    chart = Scatter(init_opts=opts.InitOpts(width="750px", height="600px"))
    chart.add_xaxis(atmp["year"].tolist())
    chart.add_yaxis(
        "Anomalía anual",
        atmp["temp-diff"].tolist(),
        symbol="circle",
        symbol_size=7,
        itemstyle_opts=opts.ItemStyleOpts(
            color=matplotlib_c0, border_color="#000", border_width=1, opacity=0.9
        ),
        label_opts=opts.LabelOpts(is_show=False),
    )

    # --- Decade averages ---
    for r in decade_stats.itertuples():
        y = r.avg_10yr - baseline
        line = Line()
        line.add_xaxis([int(r.year_min), int(r.year_max)])
        line.add_yaxis(
            series_name="Temperatura promedia por decada",
            y_axis=[y, y],
            symbol="none",
            is_connect_nones=True,
            linestyle_opts=opts.LineStyleOpts(color=matplotlib_c1, width=3),
            label_opts=opts.LabelOpts(is_show=False),
        )
        chart.overlap(line)

    # --- Options ---
    int_formatter = JsCode("function (v) { return Math.round(v).toString(); }")

    chart.set_global_opts(
        title_opts=opts.TitleOpts(title=f"Temperatura anual promedio – {pais}"),
        xaxis_opts=opts.AxisOpts(
            name="Año",
            type_="value",
            min_=1900,
            max_=2025,
            name_location="middle",
            name_gap=35,
            axislabel_opts=opts.LabelOpts(formatter=int_formatter),
            splitline_opts=opts.SplitLineOpts(is_show=False),
        ),
        yaxis_opts=opts.AxisOpts(
            name="Temperatura (°C)",
            name_location="middle",
            name_gap=30,
        ),
        legend_opts=opts.LegendOpts(pos_top="5%"),
        tooltip_opts=opts.TooltipOpts(trigger="item"),
    )

    return chart


# -------------------------------------------------
# Build Tabs with all countries
# -------------------------------------------------
pais_values = sorted(df["País__ESTANDAR"].unique())
tab = Tab()

for pais in pais_values:
    chart = build_chart(df, pais)
    tab.add(chart, pais)
tab.render_notebook()
```